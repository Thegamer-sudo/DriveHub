@model DriveHub.ViewModels.StudentDetailViewModel

@{
    ViewData["Title"] = "Student Details";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Student Details: @Model.Student.FullName</h1>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">Student Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> @Model.Student.FullName</p>
                    <p><strong>Email:</strong> @Model.Student.Email</p>
                    <p><strong>Phone:</strong> @Model.Student.PhoneNumber</p>
                    <p><strong>ID Number:</strong> @Model.Student.IDNumber</p>
                    <p><strong>Address:</strong> @Model.Student.Address</p>
                    <p><strong>Date of Birth:</strong> @Model.Student.DateOfBirth.ToString("dd MMM yyyy")</p>
                    <p><strong>Age Status:</strong> 
                        @try
                        {
                            var is18OrOver = DriveHub.Services.IdNumberHelper.Is18OrOver(Model.Student.IDNumber);
                                <span class="badge @(is18OrOver ? "bg-success" : "bg-warning")">
                                @(is18OrOver ? "18+ (Can Book Vehicle)" : "Under 18 (Learners Only)")
                                </span>
                        }
                        catch
                        {
                                <span class="badge bg-danger">Invalid ID</span>
                        }
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">Package & Progress</h5>
                </div>
                <div class="card-body">
                    @foreach (var package in Model.Packages)
                    {
                            <div class="mb-4 p-3 border rounded">
                                <h6>@package.DisplayName</h6>
                                <p><strong>Price:</strong> R@(package.Price)</p>

                                <!-- PHASED PROGRESS SYSTEM -->
                            @if (package.Type.ToLower().Contains("full"))
                            {
                                        <!-- FULL PACKAGE - PHASED PROGRESS -->
                                var learnersCompleted = package.LessonsCompleted >= 20;
                                var learnersProgress = package.LessonsCompleted > 20 ? 20 : package.LessonsCompleted;
                                var driversProgress = package.LessonsCompleted > 20 ? package.LessonsCompleted - 20 : 0;
                                var learnersPercentage = (learnersProgress * 100) / 20;
                                var driversPercentage = (driversProgress * 100) / 30;

                                        <!-- LEARNERS PHASE -->
                                        <div class="phase-section mb-4">
                                            <h6 class="text-primary mb-3">🎓 LEARNERS PHASE</h6>
                                            <p><strong>Total Lessons:</strong> 20 lessons</p>

                                            <div class="progress mb-3" style="height: 30px;">
                                                <div class="progress-bar @(learnersCompleted ? "bg-success" : "bg-primary")" 
                                                     role="progressbar" style="width: @learnersPercentage%;" 
                                                     aria-valuenow="@learnersProgress" aria-valuemin="0" aria-valuemax="20">
                                            @learnersProgress/20 lessons (@learnersPercentage%)
                                                </div>
                                            </div>

                                    @if (!learnersCompleted)
                                    {
                                                    <form method="post" asp-action="UpdateLessonProgress" class="mb-3">
                                                        <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                        <input type="hidden" name="packageId" value="@package.Id" />
                                                        <div class="form-group">
                                                            <label><strong>Update Learners Progress:</strong></label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control" name="lessonsCompleted" 
                                                                       value="@package.LessonsCompleted" min="0" max="20" required>
                                                                <div class="input-group-append">
                                                                    <button type="submit" class="btn btn-primary">Update</button>
                                                                </div>
                                                            </div>
                                                            <small class="form-text text-muted">Learners phase: 0 to 20 lessons</small>
                                                        </div>
                                                    </form>

                                        @if (learnersProgress == 20)
                                        {
                                                            <form method="post" asp-action="MarkPackageComplete">
                                                                <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                                <input type="hidden" name="packageId" value="@package.Id" />
                                                                <button type="submit" class="btn btn-success btn-block" 
                                                                        onclick="return confirm('Mark Learners Phase as complete? This will unlock Drivers phase.')">
                                                                    ✅ Mark Learners Complete
                                                                </button>
                                                            </form>
                                        }
                                    }
                                    else
                                    {
                                                    <div class="alert alert-info">
                                                        <h6>✅ LEARNERS PHASE COMPLETE!</h6>
                                                        <p class="mb-0">Student ready for Drivers phase</p>
                                                    </div>
                                    }
                                        </div>

                                        <!-- DRIVERS PHASE -->
                                        <div class="phase-section @(!learnersCompleted ? "phase-locked" : "")">
                                            <h6 class="@(learnersCompleted ? "text-success" : "text-muted") mb-3">
                                                🚗 DRIVERS PHASE 
                                        @if (!learnersCompleted)
                                        {
                                                        <span class="badge bg-secondary">Locked</span>
                                        }
                                            </h6>

                                    @if (learnersCompleted)
                                    {
                                                    <p><strong>Total Lessons:</strong> 30 lessons</p>

                                                    <div class="progress mb-3" style="height: 30px;">
                                                        <div class="progress-bar @(package.IsDriverReady ? "bg-success" : "bg-info")" 
                                                             role="progressbar" style="width: @driversPercentage%;" 
                                                             aria-valuenow="@driversProgress" aria-valuemin="0" aria-valuemax="30">
                                                @driversProgress/30 lessons (@driversPercentage%)
                                                        </div>
                                                    </div>

                                        @if (!package.IsDriverReady)
                                        {
                                                            <form method="post" asp-action="UpdateLessonProgress" class="mb-3">
                                                                <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                                <input type="hidden" name="packageId" value="@package.Id" />
                                                                <div class="form-group">
                                                                    <label><strong>Update Drivers Progress:</strong></label>
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control" name="lessonsCompleted" 
                                                                               value="@package.LessonsCompleted" min="20" max="50" required>
                                                                        <div class="input-group-append">
                                                                            <button type="submit" class="btn btn-info">Update</button>
                                                                        </div>
                                                                    </div>
                                                                    <small class="form-text text-muted">Drivers phase: 20 to 50 lessons</small>
                                                                </div>
                                                            </form>

                                            @if (driversProgress == 30)
                                            {
                                                                    <form method="post" asp-action="MarkPackageComplete">
                                                                        <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                                        <input type="hidden" name="packageId" value="@package.Id" />
                                                                        <button type="submit" class="btn btn-success btn-block"
                                                                                onclick="return confirm('Mark Drivers Phase as complete? Student will be DRIVER READY for vehicle booking.')">
                                                                            🎓 Mark Driver Ready
                                                                        </button>
                                                                    </form>
                                            }
                                        }
                                        else
                                        {
                                                            <div class="alert alert-success">
                                                                <h6>🎓 DRIVER READY!</h6>
                                                                <p class="mb-0">Student certified on @package.DriverReadyDate?.ToString("dd MMM yyyy")</p>
                                                                <small>Student can now book vehicles for driving test</small>
                                                            </div>
                                        }
                                    }
                                    else
                                    {
                                                    <div class="progress mb-3" style="height: 30px; background-color: #e9ecef;">
                                                        <div class="progress-bar bg-secondary" style="width: 0%;">
                                                            0/30 lessons (0%)
                                                        </div>
                                                    </div>
                                                    <div class="alert alert-secondary">
                                                        <small>🔒 Complete Learners phase to unlock Drivers lessons</small>
                                                    </div>
                                    }
                                        </div>
                            }
                            else
                            {
                                        <!-- SINGLE PACKAGE - ORIGINAL DISPLAY -->
                                        <p><strong>Total Lessons:</strong> @package.LessonCount</p>

                                        <!-- Progress Management -->
                                        <div class="lesson-management mt-3">
                                            <form method="post" asp-action="UpdateLessonProgress" class="mb-3">
                                                <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                <input type="hidden" name="packageId" value="@package.Id" />
                                                <div class="form-group">
                                                    <label><strong>Update Lessons Completed:</strong></label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" name="lessonsCompleted" 
                                                               value="@package.LessonsCompleted" min="0" max="@package.LessonCount" 
                                                               required>
                                                        <div class="input-group-append">
                                                            <button type="submit" class="btn btn-primary">Update Progress</button>
                                                        </div>
                                                    </div>
                                                    <small class="form-text text-muted">Enter number of lessons completed (0 to @package.LessonCount)</small>
                                                </div>
                                            </form>

                                            <!-- Progress Bar -->
                                    @{
                                        var progressPercentage = package.LessonCount > 0 ?
                                            (package.LessonsCompleted * 100) / package.LessonCount : 0;
                                    }
                                            <div class="progress mb-3" style="height: 30px;">
                                                <div class="progress-bar @(package.IsDriverReady ? "bg-success" : "bg-primary")" 
                                                     role="progressbar" style="width: @progressPercentage%;" 
                                                     aria-valuenow="@package.LessonsCompleted" 
                                                     aria-valuemin="0" aria-valuemax="@package.LessonCount">
                                            @package.LessonsCompleted/@package.LessonCount lessons (@progressPercentage%)
                                                </div>
                                            </div>

                                            <!-- Driver Ready Status -->
                                    @if (package.IsDriverReady)
                                    {
                                                    <div class="alert alert-success">
                                                        <h6>🎓 LESSONS COMPLETE!</h6>
                                                        <p class="mb-0">Student certified on @package.DriverReadyDate?.ToString("dd MMM yyyy")</p>
                                            @if (!package.Type.ToLower().Contains("learners"))
                                            {
                                                                <small>Student can now book vehicles for driving test</small>
                                            }
                                                    </div>
                                    }
                                    else if (package.LessonsCompleted == package.LessonCount)
                                    {
                                                    <form method="post" asp-action="MarkPackageComplete">
                                                        <input type="hidden" name="studentId" value="@Model.Student.Id" />
                                                        <input type="hidden" name="packageId" value="@package.Id" />
                                                        <button type="submit" class="btn btn-success btn-block"
                                                                onclick="return confirm('Mark this package as complete? Student will be marked as ready.')">
                                                            ✅ Mark Complete
                                                        </button>
                                                    </form>
                                    }
                                        </div>
                            }
                            </div>
                    }

                    @if (Model.Receipts.Any())
                    {
                                <div class="mt-3">
                                    <h6>Payment Receipts:</h6>
                            @foreach (var receipt in Model.Receipts)
                            {
                                                <span class="badge bg-success mr-1">@receipt.ReceiptNumber</span>
                            }
                                </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">Student Notes</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="AddStudentNotes">
                        <input type="hidden" name="studentId" value="@Model.Student.Id" />
                        <div class="form-group">
                            <label for="notes"><strong>Add Notes:</strong></label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Add notes about student progress, behavior, or special requirements..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-info">Save Notes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="@Url.Action("MyStudents")" class="btn btn-secondary">
            ← Back to My Students
        </a>
    </div>
</div>

<style>
    .phase-section {
        border-left: 4px solid #0d6efd;
        padding-left: 15px;
        margin-bottom: 25px;
    }

    .phase-locked {
        opacity: 0.7;
    }

    .phase-locked .progress {
        background-color: #f8f9fa;
    }

    .border.rounded {
        background-color: #f8f9fa;
    }
</style>