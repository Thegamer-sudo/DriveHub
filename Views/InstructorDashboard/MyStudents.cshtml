@model List<DriveHub.ViewModels.StudentDetailViewModel>

@{
    ViewData["Title"] = "My Students";
}

<h1>My Students</h1>
<p class="lead">Manage your assigned driving students</p>

@if (TempData["SuccessMessage"] != null)
{
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✅ Success!</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
}

@if (TempData["ErrorMessage"] != null)
{
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>❌ Error!</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
}

@if (Model.Any())
{
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Student Name</th>
                        <th>Contact</th>
                        <th>Packages</th>
                        <th>Lesson Progress</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var studentDetail in Model)
                {
                            <tr>
                                <td>
                                    <strong>@studentDetail.Student.FullName</strong>
                                </td>
                                <td>
                            @studentDetail.Student.Email<br>
                                    <small>@studentDetail.Student.PhoneNumber</small>
                                </td>
                                <td>
                            @foreach (var package in studentDetail.Packages)
                            {
                                            <span class="badge bg-primary mb-1">@package.Type</span>
                                            <br>
                            }
                                </td>
                                <td>
                            @foreach (var package in studentDetail.Packages)
                            {
                                            <!-- PHASED PROGRESS FOR INSTRUCTOR VIEW -->
                                @if (package.Type.ToLower().Contains("full"))
                                {
                                                    <!-- FULL PACKAGE - SHOW PHASED PROGRESS -->
                                    var learnersCompleted = package.LessonsCompleted >= 20;
                                    var learnersProgress = package.LessonsCompleted > 20 ? 20 : package.LessonsCompleted;
                                    var driversProgress = package.LessonsCompleted > 20 ? package.LessonsCompleted - 20 : 0;

                                                    <div class="phase-section mb-3">
                                                        <small class="text-primary"><strong>🎓 Learners:</strong> @learnersProgress/20</small>
                                                        <div class="progress mb-1" style="height: 15px;">
                                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                                 style="width: @((learnersProgress * 100) / 20)%;">
                                                            </div>
                                                        </div>

                                                        <small class="text-success"><strong>🚗 Drivers:</strong> @driversProgress/30</small>
                                                        <div class="progress" style="height: 15px;">
                                                            <div class="progress-bar bg-success" role="progressbar" 
                                                                 style="width: @((driversProgress * 100) / 30)%;">
                                                            </div>
                                                        </div>
                                                    </div>
                                }
                                else
                                {
                                                    <!-- SINGLE PACKAGE - ORIGINAL DISPLAY -->
                                                    <div class="progress mb-2" style="height: 20px;">
                                                        <div class="progress-bar @(package.IsDriverReady ? "bg-success" : "bg-primary")" 
                                                             role="progressbar" 
                                                             style="width: @((package.LessonsCompleted * 100) / package.LessonCount)%;" 
                                                             aria-valuenow="@package.LessonsCompleted" 
                                                             aria-valuemin="0" 
                                                             aria-valuemax="@package.LessonCount">
                                            @package.LessonsCompleted/@package.LessonCount
                                                        </div>
                                                    </div>
                                }
                            }
                                </td>
                                <td>
                            @{
                                var anyPackageComplete = studentDetail.Packages.Any(p => p.IsDriverReady);
                                var allPackagesComplete = studentDetail.Packages.All(p => p.IsDriverReady);
                            }

                            @if (allPackagesComplete)
                            {
                                            <span class="badge bg-success">All Complete</span>
                            }
                            else if (anyPackageComplete)
                            {
                                            <span class="badge bg-info">Partially Complete</span>
                            }
                            else
                            {
                                            <span class="badge bg-warning">In Progress</span>
                            }
                                </td>
                                <td>
                                    <a href="@Url.Action("StudentDetails", new { studentId = studentDetail.Student.Id })" 
                                       class="btn btn-primary btn-sm">Manage</a>

                            @foreach (var package in studentDetail.Packages)
                            {
                                @if (!package.IsDriverReady)
                                {
                                                    <form method="post" action="@Url.Action("MarkPackageComplete", new { studentId = studentDetail.Student.Id, packageId = package.Id })" 
                                                          style="display: inline-block;" onsubmit="return confirmMarkComplete('@package.Type')">
                                                        <button type="submit" class="btn btn-success btn-sm mt-1">
                                                            Mark Complete
                                                        </button>
                                                    </form>
                                    break;
                                }
                            }
                                </td>
                            </tr>
                }
                </tbody>
            </table>
        </div>
}
else
{
        <div class="alert alert-info">
            <h4>No Students Assigned</h4>
            <p>You don't have any students assigned to you yet.</p>
        </div>
}

<a href="@Url.Action("Index")" class="btn btn-secondary">Back to Dashboard</a>

<style>
    .phase-section {
        border-left: 3px solid #0d6efd;
        padding-left: 10px;
        margin-bottom: 15px;
    }

    .phase-section small {
        font-size: 0.75rem;
    }

    .progress {
        margin-bottom: 8px;
    }
</style>

@section Scripts {
        <script>
            function confirmMarkComplete(packageType) {
                return confirm(`Mark ${packageType} as completed? Student will be marked as ready for the next phase!`);
            }
        </script>
}